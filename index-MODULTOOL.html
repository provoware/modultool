<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GridTool Pro – Fokus & Themes</title>
  <link rel="stylesheet" href="modules/common.css" />
  <style>
    :root {
      --sidebar-width-left: 240px;
      --sidebar-width-right: 260px;
      --sidebar-min: 120px;
      --sidebar-max: 480px;
      --sidebar-bg: #23293af9;
      --sidebar-txt: #f4f8fd;
      --sidebar-accent: #15b57b;
      --sidebar-divider: #1b3559;
      --dragbar-width: 12px;
      --bg: #181d20;
      --area: #22252a;
      --header: #22262c;
      --footer: #191c1e;
      --shadow: #0007;
      --text: #f4f8fd;
      --text-light: #bac1d1;
      --text-alt: #7fa993;
      --button: #19d27c;
      --button-hover: #11995d;
      --edit: #2a82f7;
      --edit-hover: #1b66b3;
      --remove: #db3665;
      --remove-hover: #a51636;
      --genre-bg: #23282e;
      --input: #24272f;
      --help: #192017;
      --active: #28a89e;
      --dashboard: #1d262c;
      --dashboard-light: #ececec;
      --accent: #2ccfa0;
      --accent-hover: #15986b;
      --tmpl-btn-bg: #28322e;
      --tmpl-btn-bg-hover: #338a5d;
      --highlight: #46c1f6;
      --field-border: #2ccfa0;
      --focus-ring: var(--field-border);
      --field-error: #c53c3c;
      --base-font: 16px;
      --font-family: 'Segoe UI', Arial, sans-serif;
      --btn-radius: 0.5rem;
    }
    [data-theme="light"] {
      --bg: #f9fafc;
      --area: #ebf0f7;
      --header: #dbe8f1;
      --footer: #d4dde3;
      --text: #273446;
      --text-light: #52607b;
      --text-alt: #3c735c;
      --sidebar-bg: #eaf5fd;
      --sidebar-txt: #173140;
      --sidebar-accent: #219676;
      --sidebar-divider: #bbe4fd;
      --genre-bg: #dae7ef;
      --input: #edf3fb;
      --button: #27c57d;
      --button-hover: #0b9564;
      --edit: #187ae3;
      --edit-hover: #1755a7;
      --remove: #e74668;
      --remove-hover: #bb1c38;
      --help: #e3f2e8;
      --dashboard: #e9f0f9;
      --dashboard-light: #f3f9fb;
      --tmpl-btn-bg: #cfe2c4;
      --tmpl-btn-bg-hover: #b0dab9;
      --highlight: #0096db;
      --field-border: #1fb897;
      --focus-ring: var(--field-border);
      --field-error: #c53c3c;
    }
    [data-theme="blue"] {
      --bg: #0e1c2b;
      --area: #182642;
      --header: #1c3353;
      --footer: #14284a;
      --text: #d7eaff;
      --text-light: #9cc3e1;
      --text-alt: #3bd2b7;
      --sidebar-bg: #152642f0;
      --sidebar-txt: #b9e6fe;
      --sidebar-accent: #25daf7;
      --sidebar-divider: #1a2b49;
      --genre-bg: #15305c;
      --input: #142852;
      --button: #24d1f5;
      --button-hover: #12a4bb;
      --edit: #2df3be;
      --edit-hover: #1b9276;
      --remove: #d94189;
      --remove-hover: #a21d67;
      --help: #13315c;
      --dashboard: #223462;
      --dashboard-light: #2d4a7a;
      --tmpl-btn-bg: #235677;
      --tmpl-btn-bg-hover: #1ca0da;
      --highlight: #17e9e0;
      --field-border: #25daf7;
      --focus-ring: var(--field-border);
      --field-error: #d45e91;
    }
    [data-theme="trash"] {
      --bg: #1b1b1b;
      --area: #2c2c2c;
      --header: #3d3d3d;
      --footer: #3d3d3d;
      --text: #f8f8f8;
      --text-light: #ccc;
      --text-alt: #fba55d;
      --sidebar-bg: #282828f0;
      --sidebar-txt: #f8f8f8;
      --sidebar-accent: #e61c5d;
      --sidebar-divider: #444;
      --genre-bg: #363636;
      --input: #3a3a3a;
      --button: #e61c5d;
      --button-hover: #b80e4c;
      --edit: #f0c808;
      --edit-hover: #e8b200;
      --remove: #c01c1c;
      --remove-hover: #9a1010;
      --help: #252525;
      --dashboard: #333;
      --dashboard-light: #444;
      --tmpl-btn-bg: #5a1a3c;
      --tmpl-btn-bg-hover: #9a104d;
      --highlight: #ff2c79;
      --field-border: #e61c5d;
      --focus-ring: var(--field-border);
      --field-error: #ff4c6e;
    }
    [data-theme="contrast"] {
      --bg: #000;
      --area: #000;
      --header: #222;
      --footer: #222;
      --text: #fff;
      --text-light: #fff;
      --text-alt: #ff0;
      --sidebar-bg: #000;
      --sidebar-txt: #fff;
      --sidebar-accent: #0f0;
      --sidebar-divider: #555;
      --genre-bg: #111;
      --input: #222;
      --button: #ff0;
      --button-hover: #ffa500;
      --edit: #0ff;
      --edit-hover: #0af;
      --remove: #f00;
      --remove-hover: #c00;
      --help: #333;
      --dashboard: #111;
      --dashboard-light: #222;
      --tmpl-btn-bg: #330;
      --tmpl-btn-bg-hover: #550;
      --highlight: #f00;
      --field-border: #0f0;
      --focus-ring: var(--field-border);
      --field-error: #f00;
    }
    [data-theme="minimal"] {
      --bg: #ffffff;
      --area: #f5f5f5;
      --header: #ffffff;
      --footer: #ffffff;
      --text: #000000;
      --text-light: #444444;
      --text-alt: #006600;
      --sidebar-bg: #eeeeee;
      --sidebar-txt: #111111;
      --sidebar-accent: #666666;
      --sidebar-divider: #cccccc;
      --genre-bg: #f5f5f5;
      --input: #ffffff;
      --button: #aaaaaa;
      --button-hover: #888888;
      --edit: #0066cc;
      --edit-hover: #005499;
      --remove: #cc3333;
      --remove-hover: #991111;
      --help: #dddddd;
      --dashboard: #eeeeee;
      --dashboard-light: #f5f5f5;
      --tmpl-btn-bg: #dddddd;
      --tmpl-btn-bg-hover: #cccccc;
      --highlight: #0066cc;
      --field-border: #aaaaaa;
      --focus-ring: var(--field-border);
      --field-error: #cc3333;
    }

    html, body {
      min-height: 100vh; width: 100vw; background: var(--bg); color: var(--text); margin:0; padding:0;
      font-family: var(--font-family, 'Segoe UI', Arial, sans-serif); font-size: var(--base-font, 16px); line-height:1.5;
      overflow-x: hidden; overflow-y: hidden; display:flex; flex-direction:column;
    }
    header, footer {
      background: var(--header); color: var(--text-alt); width:100vw; min-width:320px; text-align:center;
      font-weight:bold; letter-spacing:.06em; z-index:3;
    }
    header { font-size:1.17rem; padding:1.05rem 0 .8rem 0; box-shadow:0 2px 12px var(--shadow);}
    header.top-header {display:flex;align-items:center;gap:.5em;justify-content:center;flex-wrap:wrap;}
    .fokus-bar {
      display:flex;align-items:center;justify-content:flex-end;
      gap:1em; margin-bottom:.5em;
    }
    .fokus-btn {
      background: var(--highlight);
      color: #fff;
      font-weight: 600;
      border-radius: 1em;
      padding: .52em 1.3em;
      font-size: 1.06em;
      border: none;
      cursor: pointer;
      margin: 0 1.4em;
      box-shadow: 0 1px 7px var(--shadow);
      transition: background .2s, color .2s;
      outline: none;
    }
    .fokus-btn:focus { box-shadow: 0 0 0 3px var(--focus-ring); }
    .fokus-btn[aria-pressed="true"] { background: var(--button); color: #fff; }
    .panel-focus-btn{align-self:flex-end;background:var(--highlight);color:#fff;border:none;padding:.32em .8em;border-radius:.8em;cursor:pointer;margin-bottom:.5em;}
    .mod-panel.fokus .panel-focus-btn{display:block;width:100%;margin-bottom:1em;font-size:1.05em;}
    footer { font-size:1.03rem; padding:.95rem 0; background: var(--footer); color: var(--text-alt); box-shadow:0 -2px 10px var(--shadow);}
    .app-frame {
      display: grid;
      grid-template-columns: minmax(var(--sidebar-min), 20vw) var(--dragbar-width) 1fr var(--dragbar-width) minmax(var(--sidebar-min), 21vw);
      grid-template-rows: 1fr;
      width: 100vw; flex:1 1 auto; max-width: 99vw; box-sizing:border-box;
      overflow-y:auto;
    }
    .sidebar {
      background: var(--sidebar-bg); color: var(--sidebar-txt);
      display: flex; flex-direction: column;
      padding: 1.2em 1.1em .7em 1.1em;
      min-width: var(--sidebar-min); max-width: var(--sidebar-max);
      width: 100%; height: 100%; box-sizing: border-box;
      overflow-x: hidden; overflow-y: auto; z-index:2;
    }
    .sidebar.left { grid-column:1; width:clamp(var(--sidebar-min), 20vw, var(--sidebar-max));}
    .sidebar.right { grid-column:5; width:clamp(var(--sidebar-min), 21vw, var(--sidebar-max));}
    .sidebar-header {font-size:1.12em; font-weight:600; margin-bottom:1em; color:var(--sidebar-accent);}
    .sidebar-divider {border-bottom:1px solid var(--sidebar-divider); margin:.9em 0;}
    .sidebar-list {margin:0; padding:0 0 0 .3em; list-style:none;}
    .sidebar-list li {margin-bottom:.65em;display:flex;align-items:center;gap:.5em;}
    .sidebar-checkbox {width:1.13em; height:1.13em; accent-color:var(--sidebar-accent);}
    .sidebar-footer {margin-top:auto; color:var(--sidebar-accent); font-size:.93em;}
    .sidebar-h2 {font-size:1.13em; font-weight:500; margin:.35em 0 .63em 0;}
    .module-toggle-btn{background:var(--sidebar-accent);color:#fff;border:none;padding:.4em .9em;border-radius:.8em;margin-bottom:.6em;cursor:pointer;}
    .sidebar-toggle{background:var(--button);color:var(--text);border:none;padding:.4em .7em;border-radius:.6em;cursor:pointer;display:none;}
    #moduleListWrap{margin-bottom:.6em;}
    #moduleListWrap.hidden{display:none;}
    #moduleSearch{width:100%;margin-bottom:.5em;padding:.4em;border-radius:.6em;border:1px solid var(--sidebar-divider);}
    .fav-btn{margin-left:auto;background:none;border:none;color:var(--sidebar-accent);cursor:pointer;font-size:1.1em;line-height:1;}
    .sidebar-btns button {margin:.17em .22em .22em 0; padding:.64em 1.25em; background:var(--sidebar-accent); color:#fff; border:none; border-radius:1.2em; cursor:pointer;}
    .sidebar-btns button.active {background:var(--area); color:var(--sidebar-txt);}
    .dragbar { grid-row: 1; width: var(--dragbar-width); background: transparent; cursor: ew-resize; z-index:10; position: relative;}
    .dragbar.left { grid-column:2;}
    .dragbar.right { grid-column:4;}
    .dragbar-inner { position:absolute; top:0; left:0; right:0; bottom:0;
      background: linear-gradient(to right, transparent 45%, var(--sidebar-accent) 52%, transparent 55%);
      border-radius: 6px; width: 100%; height: 100%;
      opacity:.4; transition:opacity .17s;
    }
    .dragbar:hover .dragbar-inner, .dragbar:active .dragbar-inner { opacity:.85;}
    .main-content { grid-column:3; width:100%; height:100%; display:flex; justify-content:center; align-items:stretch; transition: width .17s;}
    .grid-main {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(18rem, 33%, 22rem), 1fr));
      grid-auto-rows: minmax(160px, auto);
      grid-auto-flow: row dense;
      gap: clamp(0.5rem, 2vw, 1rem);
      max-width: 1380px;
      width: 97vw;
      margin: 22px auto 24px auto;
      min-height: 70vh;
    }
    .mod-panel {
      background: var(--area); border-radius: 1.55rem; box-shadow: 0 4px 18px var(--shadow);
      padding: 1.22rem 1.12rem; display: flex; flex-direction: column;
      min-width:0; margin:0; overflow-x: hidden; overflow-y: auto; transition: box-shadow .18s,border .18s;
      border:2.2px solid transparent;
    }
    .mod-panel.fokus {box-shadow:0 0 0 6px var(--highlight),0 4px 22px var(--shadow);border:2.2px solid var(--focus-ring);}
    body.focus-mode .mod-panel.fokus {height:100vh;}
    .mod-panel h2 {
      font-size:1.16rem; margin-top:0; margin-bottom:.64rem; color:var(--text);
      position:sticky; top:0; background:var(--area); padding:.4rem 0; z-index:1;
    }
    .input-group { display: flex; gap: .5rem; margin-bottom: 1rem; }
    input, button, select, textarea {
      border-radius: 1rem; border: 1.7px solid var(--field-border); outline: none; padding: 0.7rem 1.1rem; font-size: 1rem; background: var(--input); color: var(--text); transition: border .16s,box-shadow .17s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: var(--focus-ring);
      box-shadow:0 0 0 2.5px var(--focus-ring);
    }
    input:disabled, textarea:disabled {background:var(--area);opacity:.78;}
    button {
      background: var(--button); color: var(--text); font-weight: bold; cursor: pointer; border: none;
      transition: background .2s, color .16s, box-shadow .18s;
      box-shadow:0 1.5px 7px var(--shadow);
    }
    button:hover, button:focus { background: var(--button-hover); color:#fff; }
    .archive-actions, .rand-actions { display: flex; gap: 0.6rem; flex-wrap: wrap; margin-bottom: .6rem;}
    .rand-btn { background:var(--accent);color:#fff;border-radius:1em;font-size:1.03em;padding:.52em 1.3em;font-weight:600;cursor:pointer;}
    .rand-btn:hover, .rand-btn:focus { background:var(--accent-hover);}
    .rand-result { font-size:1.05em; background:var(--genre-bg); padding:.67em 1em; border-radius:.7em; margin:.4em 0; word-break:break-all;}
    .search-group { margin-bottom: .6rem; display: flex; align-items: center; gap:.5rem;}
    .search-clear { background: var(--edit); color: #fff; font-size:1em; padding: .17em .7em; border-radius:.7em;}
    .search-clear:hover { background: var(--edit-hover);}
    .archive-list { flex: 1 1 auto; overflow-y: auto; min-height: 0; margin-bottom: .6rem; }
    ul { list-style: none; padding: 0; margin: 0; }
    li { background: var(--genre-bg); padding: 0.45rem 1rem; border-radius: 1rem; margin-bottom: 0.18rem; display: flex; align-items: center; justify-content: space-between; font-size: 1em; }
    .genre-text { flex: 1; word-break: break-all; cursor: pointer;}
    .genre-edit { background: var(--input); color: var(--text); border: 1px solid var(--field-border); font-size: 1em; border-radius: 1em; padding: 0.3rem 0.8rem; width: 70%; margin-right: .6em; }
    .edit-btn { background: var(--edit); margin-left: .7rem; }
    .edit-btn:hover, .edit-btn:focus { background: var(--edit-hover);}
    .remove-btn { background: var(--remove); margin-left: .7rem; }
    .remove-btn:hover, .remove-btn:focus { background: var(--remove-hover);}
    .dashboard-list { margin:0.2em 0 0.2em 0; padding:0; list-style:none;}
    .dashboard-list li { background: var(--dashboard-light); color: var(--text-alt); border-radius: .6em; margin-bottom: .25em; padding: .45em .8em; font-size:.97em; display: flex; align-items: center; justify-content: space-between; gap:.5em; word-break:break-all;}
    .dashboard-copy {background:var(--edit);color:#fff;font-size:1em;border-radius:.6em;padding:.18em .6em; border:none;}
    .dashboard-copy:hover {background:var(--edit-hover);}
    .copy-btn {background:var(--button);color:#fff;border:none;padding:.2em .7em;border-radius:.7em;margin-left:.5em;cursor:pointer;}
    .copy-btn:focus,.copy-btn:hover{background:var(--button-hover);}
    .dashboard-timestamp { font-size:.87em; color:var(--text-light); margin-right:.2em;}
    .tmpl-inputs {display:flex; gap:.7em; margin-bottom:.7em;flex-wrap:wrap;}
    .tmpl-inputs input {min-width:110px;flex:1;}
    .tmpl-inputs textarea {min-width:140px;flex:2;resize:vertical;}
    .tmpl-btnlist {display:flex; flex-wrap:wrap; gap:.5em;}
    .tmpl-btn {
      background: var(--tmpl-btn-bg); color: var(--text); border:none;
      border-radius:1.2em; padding:.6em 1.3em; margin-bottom:.4em;
      cursor:pointer; font-weight:600; font-size:1em; max-width:100%; transition:background .18s;
      display:inline-flex; align-items:center; justify-content:center; word-break:break-word;
    }
    .tmpl-btn:hover, .tmpl-btn:focus {background:var(--tmpl-btn-bg-hover);}
    .tmpl-remove {background:var(--remove); color:#fff; border-radius:.9em; border:none; padding:.21em .7em; margin-left:.7em; font-size:1.05em; cursor:pointer;}
    .tmpl-remove:hover {background:var(--remove-hover);}
    .debug-log {font-size:1em;background:#181f1f;color:#ececec;border-radius:.7em;padding:.5em 1em;margin:.15em 0;}
    .debug-err {color:#e95858;}
    .debug-info{color:#5ecea6;}
    .input-help {color:var(--text-light);font-size:.97em;margin:.2em 0 .5em .1em;}
    .file-label {padding:.3em .8em;border-radius:.8em;background:var(--area);margin-left:.3em;cursor:pointer;}
    .help-btn {padding:.3em .8em;border-radius:.6em;background:var(--button);color:var(--text);border:none;cursor:pointer;}
    .import-status{font-size:.98em;margin:.45em 0;}
    .weight-list{display:flex;flex-direction:column;gap:.4em;max-height:220px;overflow:auto;margin-bottom:.6em;}
    .weight-row{display:flex;align-items:center;gap:.6em;}
    .weight-row span{flex:1;word-break:break-all;}
    .weight-row input{width:60px;}
    .profile-actions{display:flex;flex-wrap:wrap;gap:.5em;margin:.5em 0;}
    .profile-actions input,.profile-actions select{flex:1 1 130px;min-width:120px;}
    .profile-actions button{padding:.3em .9em;}
    .small { font-size: .93rem; color: var(--text-light);}
    .placeholder { font-size:.95rem; color:var(--text-light); margin:.3em 0; }
    .status-msg {padding:.19em 1em; margin:.2em 0 .4em 0; border-radius:.7em; font-weight:600;}
    .status-ok {background:#198d54b8; color:#f7fff9;}
    .status-error {background:#d42e4cbe; color:#fff;}
    .toast-layer{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);padding:.4em 1em;border-radius:.7em;font-weight:600;display:none;z-index:9999;}
    .toast-ok{background:#198d54b8;color:#f7fff9;}
    .toast-error{background:#d42e4cbe;color:#fff;}
    .flash-success {background:var(--active) !important; transition:background .3s;}
    .flash-error {background:var(--remove) !important; transition:background .3s;}
    .intro-overlay {position:fixed;inset:0;background:rgba(0,0,0,.85);color:var(--text);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;text-align:center;padding:1em;}
    .intro-overlay button{margin-top:1em;padding:.6em 1.2em;border:none;border-radius:.4em;background:var(--button);color:var(--text);font-size:1.1em;cursor:pointer;}
    .intro-overlay .intro-close{position:absolute;top:.5em;right:.5em;background:none;font-size:1.4em;border:none;color:var(--text);cursor:pointer;}
    @media (max-width: 1100px) {
      .mod-panel {max-height:none;}
    }
    @media (max-width: 780px) {
      .app-frame {grid-template-columns:1fr;}
      .dragbar{display:none;}
      .sidebar {position:fixed;top:0;bottom:0;width:85vw;max-width:360px;height:100vh;transform:translateX(-110%);transition:transform .3s;}
      .sidebar.left{left:0;}
      .sidebar.right{right:0;transform:translateX(110%);}
      .sidebar.show{transform:translateX(0);}
      .sidebar-toggle{display:inline-block;}
    }
    @media (max-width: 480px) {
      header {font-size:1.2em;}
      .app-frame {grid-template-columns: 1fr var(--dragbar-width) 100vw var(--dragbar-width) 1fr;}
      .sidebar {width:96vw;min-width:90vw;max-width:99vw;}
    }
    @media (max-width: 480px) {
      header {font-size:1.2em;}
      .sidebar {width:98vw;min-width:98vw;max-width:98vw;}
      .app-frame {grid-template-columns:1fr;}
      header.top-header {flex-direction:column;gap:.3em;}
      #copySelBtn {margin-left:0;margin-top:.3em;}
    }
</style>
<script defer src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js"></script>
</head>
<body>
<div id="introOverlay" class="intro-overlay" role="dialog" aria-labelledby="introTitle">
  <button class="intro-close" aria-label="Fenster schließen" onclick="hideIntro()">×</button>
  <h2 id="introTitle">Willkommen im Modultool!</h2>
  <p>Der lokale Server läuft. Diese Seite wurde automatisch geöffnet.</p>
  <p>Klicke auf "Los geht's", um die Oberfläche zu nutzen.</p>
  <button title="Willkommensfenster schließen" onclick="hideIntro()">Los geht's</button>
</div>
<header class="top-header" role="banner">
  GridTool Pro – Fokusumschaltung &bull; &copy; Pppoppi
  <button id="copySelBtn" class="btn copy-btn" title="Markierten Text kopieren" aria-label="Text kopieren">⧉ Kopieren</button>
  <button id="toggleLeft" class="btn sidebar-toggle" aria-label="Menü umschalten">☰</button>
  <button id="toggleRight" class="btn sidebar-toggle" aria-label="Optionen umschalten">⚙</button>
</header>
<div id="toastLayer" class="toast-layer" role="status" aria-live="polite"></div>
<div class="app-frame">
  <aside class="sidebar left" id="sidebarLeft" role="navigation" aria-label="Module und Infos">
    <div class="sidebar-header">Module & Infos</div>
    <button id="moduleToggleBtn" class="btn module-toggle-btn" onclick="toggleModuleList()">Module ein/aus</button>
    <div id="moduleListWrap">
    <div class="sidebar-h2" title="Module hier ein- oder ausschalten">Module verwalten</div>
    <input id="moduleSearch" type="text" placeholder="Module filtern…" aria-label="Module filtern" />
    <ul id="moduleList" class="sidebar-list"></ul>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-h2" title="Versionshinweise und Links">Infos</div>
    <div style="font-size:.98em;">
      <b>GridTool Pro</b> <br> Fokusumschaltung & Themes<br>
      <a href="#" style="color:var(--sidebar-accent);" onclick="alert('Changelog: Fokusumschaltung, Themes optimiert, Best-Practice-Styling für Felder, Buttons, Schrift und Kontrast.');">Changelog</a>
    </div>
    <div class="sidebar-footer">
      &copy; 2025 Pppoppi &bull; Provoware
    </div>
  </aside>
  <div class="dragbar left" id="dragbarLeft"><div class="dragbar-inner"></div></div>
  <main class="main-content" role="main" aria-label="Hauptinhalt">
    <div class="fokus-bar">
      <label for="fokusSelect" style="font-weight:600;color:var(--highlight);margin-right:.3em;">Fokus-Modus:</label>
      <select id="fokusSelect" aria-label="Panel auswählen" title="Panel für den Fokus wählen" style="font-size:1.02em;border-radius:.8em;border:1.5px solid var(--highlight);padding:.25em .9em;background:var(--area);color:var(--text);">
        <option value="0">3x3-Grid (Standard)</option>
        <option value="1">Panel 1: Genres + Zufall</option>
        <option value="2">Panel 2: Archiv</option>
        <option value="3">Panel 3: Dashboard</option>
        <option value="4">Panel 4: Text-Templates</option>
        <option value="5">Panel 5: Debug & Log</option>
        <option value="6">Panel 6: Modul-Import</option>
        <option value="7">Panel 7</option>
        <option value="8">Panel 8</option>
        <option value="9">Panel 9</option>
        <option value="10">Panel 10</option>
        <option value="11">Panel 11</option>
      </select>
      <button class="fokus-btn" id="fokusResetBtn" style="display:none;" aria-pressed="true" title="Zur Übersicht" onclick="switchFokus(0)">Zurück zum Grid</button>
    </div>
    <div class="grid-main" id="gridMain">
      <section class="mod-panel" id="panel1" tabindex="0" role="region" aria-labelledby="panel1-head"><h2 id="panel1-head">Genres + Zufall</h2>
        <form id="genreForm" autocomplete="off">
          <div class="input-group">
            <input id="genreInput" type="text" placeholder="Genre(s) durch Komma getrennt…" title="Mehrere Genres mit Komma trennen" autofocus required />
            <button type="submit">➕</button>
          </div>
          <div class="input-help">Beispiel: <code>Techno, Funk, Minimal</code> (beliebig viele Genres möglich)</div>
        </form>
        <div class="archive-actions">
          <button onclick="saveArchive()">💾 Speichern</button>
          <button onclick="loadArchive()">📂 Laden</button>
          <button onclick="resetArchive()" style="background:var(--remove);">🗑️ Löschen</button>
        </div>
        <div class="profile-actions">
          <input id="profileName" type="text" placeholder="Profilname" title="Neues Profil anlegen" />
          <button id="saveProfileBtn" type="button">Profil speichern</button>
          <select id="profileSelect" title="Profil wählen"></select>
          <button id="deleteProfileBtn" type="button" style="background:var(--remove);">Profil löschen</button>
        </div>
        <div class="rand-actions">
          <button class="rand-btn" onclick="pickRandomN(3)" aria-label="Zufall 3 Genres">🎲 3</button>
          <button class="rand-btn" onclick="pickRandomN(6)" aria-label="Zufall 6 Genres">🎲 6</button>
          <button class="rand-btn" onclick="pickRandomN(9)" aria-label="Zufall 9 Genres">🎲 9</button>
          <button class="rand-btn" onclick="pickRandomN(12)" aria-label="Zufall 12 Genres">🎲 12</button>
          <button class="rand-btn" onclick="pickRandomN(15)" aria-label="Zufall 15 Genres">🎲 15</button>
        </div>
        <div id="randResult" class="rand-result" style="display:none;" role="status" aria-live="polite"></div>
        <div id="genreStatus" class="status-msg" style="display:none;" role="status" aria-live="polite"></div>
        <div class="input-help">Tipp: Jede Auswahl wird ins Dashboard übernommen. Du kannst Genres jederzeit editieren!</div>
      </section>
      <section class="mod-panel" id="panel2" tabindex="0" role="region" aria-labelledby="panel2-head"><h2 id="panel2-head">Archiv</h2>
        <div class="search-group">
          <input id="searchInput" type="text" placeholder="Suche im Archiv…" autocomplete="off" />
          <button id="clearSearch" class="search-clear" aria-label="Suche löschen" style="display:none;">✖</button>
        </div>
        <div class="archive-list">
          <ul id="genreList"></ul>
          <p id="archiveEmpty" class="placeholder" style="display:none;">Keine Genres gespeichert.</p>
        </div>
        <div class="small">Klick: kopieren | ✏: bearbeiten | ✖: entfernen</div>
        <div class="input-help">Tipp: Mit Enter bestätigst du beim Editieren, Escape bricht ab.</div>
      </section>
      <section class="mod-panel" id="panel3" tabindex="0" role="region" aria-labelledby="panel3-head"><h2 id="panel3-head">Dashboard (letzte 10 Ausgaben)</h2>
        <ul id="dashboardList" class="dashboard-list"></ul>
        <p id="dashEmpty" class="placeholder" style="display:none;">Noch keine Einträge.</p>
        <ul id="dashLog" class="dashboard-list" aria-label="Systemprotokoll"></ul>
        <button id="clearDashboardBtn" class="dashboard-copy" aria-label="Dashboard leeren" style="background:var(--remove);margin-top:.5em;">Alle löschen</button>
        <div class="input-help">Tipp: Für alle Zufallsausgaben – kopieren per Klick!</div>
      </section>
      <section class="mod-panel" id="panel4" tabindex="0" role="region" aria-labelledby="panel4-head"><h2 id="panel4-head">Text-Templates</h2>
        <form id="tmplForm" autocomplete="off">
          <div class="tmpl-inputs">
            <input id="tmplTitle" type="text" placeholder="Button-Titel" title="Titel für den Vorlagen-Button" required maxlength="40" />
            <textarea id="tmplText" placeholder="Textvorlage…" title="Inhalt der Textvorlage" required rows="2" maxlength="500"></textarea>
            <button type="submit" title="Neue Vorlage speichern">Hinzufügen</button>
          </div>
          <div class="input-help">Gib einen sprechenden Titel und Text ein. Beispiel: Titel: <code>Grußmail</code> – Text: <code>Hallo zusammen, ...</code></div>
        </form>
        <div class="tmpl-btnlist" id="tmplBtnList"></div>
        <div class="small">Klick: Text kopieren. ✖: Entfernen.</div>
        <div id="tmplStatus" class="status-msg" style="display:none;" role="status" aria-live="polite"></div>
      </section>
      <section class="mod-panel" id="panel5" tabindex="0" role="region" aria-labelledby="panel5-head"><h2 id="panel5-head">Debug & Log</h2>
        <div id="debugLog" style="max-height:220px;overflow:auto;margin-bottom:.4em;"></div>
        <button onclick="clearLog()" class="dashboard-copy" style="background:var(--remove);" title="Alle Logeinträge entfernen">Logs löschen</button>
        <div class="input-help">Hier findest du Fehler, Warnungen und Systemereignisse. Tipp: Bei Problemen einfach Logs prüfen!</div>
        <div class="small">Selfcheck: <span id="selfcheckStatus"></span></div>
      </section>
      <section class="mod-panel" id="panel6" tabindex="0" role="region" aria-labelledby="panel6-head"><h2 id="panel6-head">Modul-Import</h2>
        <label class="file-label">
          <input id="importModuleFile" type="file" accept=".js,.html,.txt" style="display:none;" />
          Modul-Datei auswählen
        </label>
        <button onclick="triggerModuleImport()">Import starten</button>
        <div class="import-status" id="importStatus" role="status" aria-live="polite"></div>
        <pre id="importPreview" style="max-height:110px;overflow:auto;background:#252c2e;color:#bbb;padding:.4em .7em;border-radius:.6em;display:none;margin:.5em 0 0 0;"></pre>
        <button id="importInsertBtn" onclick="insertImportedPanel()" style="display:none;">Einfügen</button>
        <div class="input-help">Du kannst HTML- oder JS-Moduldateien importieren. Beispiel: <code>custom_module.js</code> oder <code>toolpanel.html</code>. Fehler werden hier angezeigt.</div>
      </section>
      <section class="mod-panel" id="panel7" tabindex="0" role="region" aria-labelledby="panel7-head">
        <h2 id="panel7-head">Notizen</h2>
        <textarea id="notesArea" rows="6" placeholder="Schreibe deine Notizen..."></textarea>
        <div style="margin-top:.5em;display:flex;gap:.5em;">
          <button onclick="saveNotes()">Speichern</button>
          <button onclick="clearNotes()">Löschen</button>
        </div>
        <div class="input-help">Hinweis: Deine Notizen bleiben lokal im Browser gespeichert.</div>
      </section>
      <section class="mod-panel" id="panel8" tabindex="0" role="region" aria-labelledby="panel8-head"><h2 id="panel8-head">Modul 8</h2><div class="small">Frei für weitere Features</div></section>
      <section class="mod-panel" id="panel9" tabindex="0" role="region" aria-labelledby="panel9-head"><h2 id="panel9-head">Modul 9</h2><div class="small">Frei für weitere Features</div></section>
      <section class="mod-panel" id="panel10" tabindex="0" role="region" aria-labelledby="panel10-head"><h2 id="panel10-head">Modul 10</h2><div class="small">Frei für weitere Features</div></section>
      <section class="mod-panel" id="panel11" tabindex="0" role="region" aria-labelledby="panel11-head"><h2 id="panel11-head">Modul 11</h2><div class="small">Frei für weitere Features</div></section>
    </div>
  </main>
  <div class="dragbar right" id="dragbarRight"><div class="dragbar-inner"></div></div>
  <aside class="sidebar right" id="sidebarRight" role="complementary" aria-label="Optionen und Themes">
    <div class="sidebar-header">Optionen & Themes</div>
    <div class="sidebar-h2">Farbschema</div>
    <div class="sidebar-btns" id="themeBtnGroup"></div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-h2" title="Grundeinstellungen des Tools">Globale Einstellungen</div>
    <div>
      <button onclick="resetAll()" aria-label="Alle Daten löschen" style="margin-bottom:.5em;">Alles zurücksetzen</button>
      <button id="scrollSyncBtn" type="button" onclick="toggleScrollSync()" style="margin-left:.4em;">Scrollsync: aus</button>
    </div>
    <div class="sidebar-divider"></div>
    <div class="sidebar-h2" title="Tipps und Befehle auf einen Blick">Kurze Hilfe</div>
    <ul class="sidebar-list">
      <li>Selfcheck: <code>bash tools/selfcheck.sh</code></li>
      <li>Projekt speichern: <code>git commit</code></li>
      <li>Weitere Tipps in <code>LAIENHILFE.md</code></li>
      <li><button class="help-btn" onclick="openHelp()" title="Hilfedatei im neuen Fenster anzeigen">LAIENHILFE öffnen</button></li>
    </ul>
    <div class="sidebar-footer">
      Für Hilfe: Siehe Hilfe-Sidebar oder frag Poppi.
    </div>
  </aside>
</div>
<footer>
  &copy; 2025 Provoware • Kein Cloudzwang, keine Gendersprache, kein Tracking.
</footer>
<script>
/* ====== Fokusmodus: Umschalten zwischen 3x3 und 1x1 ====== */
const DATA_VERSION = '1';
localStorage.setItem('DATA_VERSION', DATA_VERSION);
const gridMain = document.getElementById('gridMain');
const fokusSelect = document.getElementById('fokusSelect');
const fokusResetBtn = document.getElementById('fokusResetBtn');
let fokusMode = 0;
function renderFocusSelect(){
  const sel=document.getElementById("fokusSelect");
  if(!sel) return;
  sel.innerHTML='<option value="0">3x3-Grid (Standard)</option>';
  document.querySelectorAll("#gridMain .mod-panel").forEach((p,i)=>{
    const h=p.querySelector("h2");
    const title=h?h.textContent:`Panel ${i+1}`;
    const opt=document.createElement("option");
    opt.value=String(i+1);
    opt.textContent=`Panel ${i+1}: ${title}`;
    sel.appendChild(opt);
  });
}

fokusSelect.onchange = function() { switchFokus(Number(fokusSelect.value)); };
function updateFocusButtons(){
  document.querySelectorAll('.panel-focus-btn').forEach((btn,idx)=>{
    const mode=idx+1;
    if(fokusMode===0){
      btn.textContent='Fokus';
      btn.onclick=()=>switchFokus(mode);
      btn.style.display='';
    }else if(fokusMode===mode){
      btn.textContent='Zurück';
      btn.onclick=()=>switchFokus(0);
      btn.style.display='';
    }else{
      btn.style.display='none';
    }
  });
}
function switchFokus(mode) {
  if(mode!==0) scrollCache = window.scrollY;
  fokusMode = mode;
  document.body.classList.toggle('focus-mode', mode !== 0);
  if (mode !== 0) {
    const target = document.getElementById('panel' + mode);
    if (target && target.style.display === 'none') {
      fokusSelect.value = '0';
      addLog('Panel im Fokus ausgeblendet.');
      logDbg('Panel im Fokus ausgeblendet.');
      return;
    }
  }
  document.querySelectorAll("#gridMain .mod-panel").forEach((panel,i)=>{
    if (mode === 0) {
      const box=document.getElementById("mod"+(i+1)+"box");
      panel.style.display = box && !box.checked ? "none" : "";
      panel.classList.remove("fokus");
      panel.setAttribute("aria-hidden",panel.style.display==="none"?"true":"false");
    } else {
      const on = (i === mode-1);
      panel.style.display = on ? "" : "none";
      panel.classList.toggle("fokus", on);
      panel.setAttribute("aria-hidden", on ? "false" : "true");
    }
  });

  fokusResetBtn.style.display = (mode !== 0) ? '' : 'none';
  fokusSelect.value = String(mode);
  if (mode !== 0) {
    const pf = document.getElementById('panel' + mode);
    if (pf) pf.focus();
  } else {
    window.scrollTo(0, scrollCache);
  }
  updateFocusButtons();
}
/* ====== Farbschema & Initialisierung ====== */
const themes = [
  {name:'Dunkel', key:'default'},
  {name:'Hell', key:'light'},
  {name:'Blau', key:'blue'},
  {name:'Trash', key:'trash'},
  {name:'Kontrast', key:'contrast'},
  {name:'Minimal', key:'minimal'}
];
let curTheme = localStorage.getItem('themePppoppi')||'default';
function renderThemeBtnGroup() {
  document.getElementById('themeBtnGroup').innerHTML = themes.map(th =>
    `<button class="${curTheme===th.key?'active':''}" onclick="setTheme('${th.key}')">${th.name}</button>`
  ).join('');
}
function setTheme(t) {
  if (t === 'default') {
    document.body.removeAttribute('data-theme');
  } else {
    document.body.setAttribute('data-theme', t);
  }
  curTheme = t;
  localStorage.setItem('themePppoppi', t);
  renderThemeBtnGroup();
}
window.onload = function() {
  setTheme(curTheme);
  renderThemeBtnGroup();
  switchFokus(0);
  try {
    let data = localStorage.getItem(LOCAL_KEY);
    state.genres = data ? JSON.parse(data) : [];
    let dash = localStorage.getItem(DASHBOARD_KEY);
    state.dashboardData = dash ? JSON.parse(dash) : [];
    let tdata = localStorage.getItem(TMPL_KEY);
    state.tmplArchiv = tdata ? JSON.parse(tdata) : [];
  } catch(e) {
    state.genres = []; state.dashboardData = []; state.tmplArchiv = [];
    logErr('Fehler beim Laden aus localStorage: '+e);
  }
  loadLogs();
  renderList();
  renderDashboard();
  renderDashLog();
  renderTmplList();
  loadNotes();
  renderLog();
  loadProfiles();
  document.getElementById('saveProfileBtn').onclick = saveCurrentProfile;
  document.getElementById('profileSelect').onchange = e=>loadSelectedProfile(e.target.value);
  document.getElementById('deleteProfileBtn').onclick = deleteProfile;
  for(let i=4;i<=11;i++) toggleModPanel(i);
  renderFocusSelect();
  setTimeout(()=>{addFocusButtons();updateFocusButtons();},300);
  const searchField=document.getElementById('moduleSearch');
  if(searchField){
    searchField.addEventListener('input',e=>{moduleSearchTerm=e.target.value;renderModuleList();});
  }
};
/* ======= App-Logik, Panels, Logging, Dashboard usw. ======= */
const LOCAL_KEY = 'genreArchiv_vGRIDSB';
const DASHBOARD_KEY = 'genreDashboard_vGRIDSB';
const TMPL_KEY = 'tmplArchiv_vGRIDSB';
const NOTES_KEY = 'notes_vGRIDSB';
const LOG_KEY = 'logArchiv_vGRIDSB';
const WEIGHT_KEY = 'genreWeights_vGRIDSB';
const PROFILES_KEY = 'genreProfiles_vGRIDSB';
const PROFILE_LAST_KEY = 'lastGenreProfile_vGRIDSB';
const state = {
  genres: [],
  dashboardData: [],
  tmplArchiv: [],
  notesData: '',
  genreWeights: {},
  searchTerm: '',
  genreProfiles: {},
  currentProfile: ''
};
let searchTimer;
let genreWeights = {};
let searchTerm = '';
const FAV_KEY = 'modFavorites_v1';
let favorites = [];
let modulesConfig = [];
let scrollSync = false;
let scrollCache = 0;
function loadProfiles(){
  try{ state.genreProfiles = JSON.parse(localStorage.getItem(PROFILES_KEY)) || {}; }
  catch(e){ state.genreProfiles = {}; logErr('Profile-Laden: '+e); }
  if(Object.keys(state.genreProfiles).length===0){
    state.genreProfiles = {Hart:[], Schnell:[], Chill:[]};
    saveProfiles();
  }
  state.currentProfile = localStorage.getItem(PROFILE_LAST_KEY) || '';
  renderProfileSelect();
  if(state.currentProfile && state.genreProfiles[state.currentProfile]){
    state.genres = [...state.genreProfiles[state.currentProfile]];
    sortAndUpdate();
  }
}
function saveProfiles(){
  localStorage.setItem(PROFILES_KEY, JSON.stringify(state.genreProfiles));
  localStorage.setItem(PROFILE_LAST_KEY, state.currentProfile);
}
function renderProfileSelect(){
  const sel=document.getElementById('profileSelect');
  if(!sel) return;
  sel.innerHTML='';
  const placeholder=document.createElement('option');
  placeholder.textContent='Profil wählen';
  placeholder.disabled=true;
  if(!state.currentProfile) placeholder.selected=true;
  sel.appendChild(placeholder);
  Object.keys(state.genreProfiles).forEach(n=>{
    const opt=document.createElement('option');
    opt.value=n; opt.textContent=n;
    if(n===state.currentProfile) opt.selected=true;
    sel.appendChild(opt);
  });
}
function saveCurrentProfile(){
  const name=document.getElementById('profileName').value.trim();
  if(!name){statusMsg('Profilname fehlt!',0);return;}
  state.genreProfiles[name]=[...state.genres];
  state.currentProfile=name;
  saveProfiles();
  renderProfileSelect();
  statusMsg('Profil gespeichert: '+name,1);
}
function loadSelectedProfile(name){
  if(!state.genreProfiles[name]) return;
  state.currentProfile=name;
  state.genres=[...state.genreProfiles[name]];
  sortAndUpdate();
  saveProfiles();
  renderProfileSelect();
  statusMsg('Profil geladen: '+name,1);
}
function deleteProfile(){
  const name=document.getElementById('profileSelect').value;
  if(!name) return;
  if(confirm('Profil '+name+' löschen?')){
    delete state.genreProfiles[name];
    if(state.currentProfile===name){state.currentProfile='';state.genres=[];}
    saveProfiles();
    renderProfileSelect();
    sortAndUpdate();
    statusMsg('Profil gelöscht: '+name,1);
  }
}
/* Logging und Selfcheck */
let logArr = [];
function loadLogs(){
  try{
    const d=localStorage.getItem(LOG_KEY);
    logArr=d?JSON.parse(d):[];
  }catch(e){
    logArr=[];
  }
}
function addDashboardEntry(text) {
  state.dashboardData.unshift({ value: text, time: new Date().toLocaleString() });
  state.dashboardData = state.dashboardData.slice(0,10);
  localStorage.setItem(DASHBOARD_KEY, JSON.stringify(state.dashboardData));
  renderDashboard();
}
function addLog(msg, type='info') {
  logArr.unshift({time:new Date().toLocaleTimeString(), type, msg});
  if(logArr.length>64) logArr.pop();
  localStorage.setItem(LOG_KEY, JSON.stringify(logArr));
  renderLog();
  renderDashLog();
}
function logErr(msg){ addLog(msg, 'err'); }
function renderLog(){
  const out = document.getElementById('debugLog');
  if(out) out.innerHTML = logArr.map(e=>`<div class="debug-log debug-${e.type}">[${e.time}] ${e.msg}</div>`).join('');
  document.getElementById('selfcheckStatus').innerHTML = selfcheckResult();
}
function renderDashLog(){
  const out = document.getElementById('dashLog');
  if(out){
    out.innerHTML = logArr.slice(0,10).map(e=>`<li><span class="dashboard-timestamp">${e.time}</span> ${e.msg}</li>`).join('');
    out.style.display = logArr.length ? 'block' : 'none';
  }
}
function clearLog(){
  logArr=[];
  localStorage.removeItem(LOG_KEY);
  renderLog();
  renderDashLog();
}
function selfcheckResult() {
  let ok = true, res = [];
  try {
    if(!Array.isArray(state.genres)) {ok=false; res.push('Genre-Archiv beschädigt');}
    if(!Array.isArray(state.dashboardData)) {ok=false; res.push('Dashboard beschädigt');}
    if(!Array.isArray(state.tmplArchiv)) {ok=false; res.push('Templates beschädigt');}
    if(!Array.isArray(logArr)) {ok=false; res.push('Logs beschädigt');}
    if(document.querySelectorAll('.mod-panel').length!==11) {ok=false; res.push('Panel-Anzahl inkonsistent');}
  } catch(e){ok=false;res.push('Selfcheck-Fehler: '+e);}
  return ok?'<span style="color:#7bd375;">OK</span>':('<span style="color:#eb8a7a;">'+res.join('; ')+'</span>');
}
/* Modul-Import */
let importModuleContent = '';
document.getElementById('importModuleFile').addEventListener('change', function(e){
  const file = e.target.files[0];
  if(!file) return;
  if(file.size>1000000 || !/\.(html|js|json)$/i.test(file.name)){
    document.getElementById('importStatus').textContent='Datei zu groß oder falscher Typ';
    logErr('Ungültige Datei: '+file.name);
    return;
  }
  const reader = new FileReader();
  reader.onload = function(ev){
    importModuleContent = ev.target.result;
    document.getElementById('importPreview').style.display='block';
    document.getElementById('importPreview').textContent = importModuleContent.substring(0,800)+(importModuleContent.length>800?' …':'');
    document.getElementById('importStatus').textContent = 'Datei geladen: '+file.name;
    document.getElementById('importInsertBtn').style.display='inline-block';
    addLog('Modul-Datei geladen: '+file.name);
  };
  reader.onerror = function() {
    document.getElementById('importStatus').textContent = 'Fehler beim Lesen der Datei!';
    logErr('Fehler beim Lesen der Modul-Datei!');
  };
  reader.readAsText(file);
});
function triggerModuleImport() {
  document.getElementById('importModuleFile').click();
}
function insertImportedPanel(){
  if(!importModuleContent){
    document.getElementById('importStatus').textContent='Keine Datei geladen!';
    return;
  }
  const container=document.getElementById('gridMain');
  const section=document.createElement('section');
  const pid='panel'+(container.children.length+1);
  section.className='mod-panel';
  section.id=pid;
  section.tabIndex=0;
  section.setAttribute('role','region');
  section.setAttribute('aria-labelledby',pid+'-label');
  section.innerHTML=DOMPurify.sanitize(importModuleContent);
  container.appendChild(section);
  document.getElementById('importInsertBtn').style.display='none';
  document.getElementById('importPreview').style.display='none';
  document.getElementById('importStatus').textContent='Panel eingefügt: '+pid;
  addLog('Importiertes Panel angelegt: '+pid);
}
/* Genre/Archiv/Random */
function renderList() {
  const list = document.getElementById('genreList');
  list.innerHTML = '';
  const ph = document.getElementById('archiveEmpty');
  ph.style.display = state.genres.length ? 'none' : 'block';
  let filter = state.searchTerm.trim().toLowerCase();
  state.genres.forEach((g, idx) => {
    let value = typeof g === 'object' ? g.value : g;
    if(filter && !value.toLowerCase().includes(filter)) return;
    const li = document.createElement('li');
    if(typeof g === 'object' && g._edit) {
      const input = document.createElement('input');
      input.type = 'text';
      input.value = g.value;
      input.className = 'genre-edit';
      input.onkeydown = e => {
        if(e.key==='Enter'){ finishEdit(idx, input.value); }
        if(e.key==='Escape'){ cancelEdit(idx); }
      };
      input.onblur = () => { finishEdit(idx, input.value); };
      li.appendChild(input);
      const btn = document.createElement('button');
      btn.innerText = '💾';
      btn.className = 'edit-btn';
      btn.onclick = () => finishEdit(idx, input.value);
      li.appendChild(btn);
    } else {
      const span = document.createElement('span');
      span.className = 'genre-text';
      span.innerText = value;
      span.title = 'Zum Kopieren klicken';
      span.onclick = () => {
        try { navigator.clipboard.writeText(value); }
        catch(e){ logErr('Clipboard-Fehler: '+e); flash(span,'flash-error'); return; }
        statusMsg("Genre kopiert!",1);
        flash(span);
      };
      li.appendChild(span);
      const edit = document.createElement('button');
      edit.innerText = '✏';
      edit.className = 'edit-btn';
      edit.onclick = () => startEdit(idx);
      li.appendChild(edit);
    }
    const rm = document.createElement('button');
    rm.className = 'remove-btn';
    rm.innerText = '✖';
    rm.onclick = () => { state.genres.splice(idx,1); sortAndUpdate(); addLog('Genre gelöscht.'); };
    li.appendChild(rm);
    list.appendChild(li);
  });
}
function startEdit(idx) {
  state.genres = state.genres.map((g, i) => i===idx ? {value: typeof g==='object'?g.value:g, _edit:true} : (typeof g==='object'?g.value:g));
  renderList();
  setTimeout(() => {
    const input = document.querySelector('input.genre-edit');
    if(input) input.focus();
  }, 100);
}
function finishEdit(idx, newVal) {
  newVal = newVal.trim();
  if(newVal && !state.genres.includes(newVal)) {
    state.genres[idx] = newVal;
  } else if (!newVal) {
    state.genres.splice(idx,1);
  } else if (state.genres.includes(newVal) && state.genres[idx] !== newVal) {
    state.genres.splice(idx,1);
  }
  sortAndUpdate();
}
function cancelEdit(idx) {
  if(typeof state.genres[idx] === 'object' && state.genres[idx]._edit) {
    state.genres[idx] = state.genres[idx].value;
    sortAndUpdate();
  }
}
function sortAndUpdate() {
  state.genres = [...new Set(state.genres.map(x => (typeof x==='object'?x.value:x).trim()).filter(x=>x.length>0))].sort((a,b)=>a.localeCompare(b, 'de'));
  localStorage.setItem(LOCAL_KEY, JSON.stringify(state.genres));
  renderList();
  renderWeightList();
  addLog('Archiv aktualisiert.');
}
function addGenre(str) {
  str.split(',').map(s=>s.trim()).filter(s=>s.length>0).forEach(s => {
    if(!state.genres.includes(s)) state.genres.push(s);
  });
  sortAndUpdate();
  addLog('Genre(s) hinzugefügt.');
}
document.getElementById('genreForm').onsubmit = (e) => {
  e.preventDefault();
  const input = document.getElementById('genreInput');
  addGenre(input.value);
  input.value = '';
  input.focus();
};
function pickRandomN(n) {
  if(state.genres.length===0) {statusMsg("Kein Genre vorhanden!",0);logErr('Zufallsgenerator ohne Genres!');return;}
  let pool = [...state.genres], picked=[];
  while(pool.length && picked.length<n){
    const idx = Math.floor(Math.random()*pool.length);
    picked.push(pool.splice(idx,1)[0]);
  }
  const result = picked.join(', ');
  document.getElementById('randResult').style.display='block';
  document.getElementById('randResult').innerHTML = `<b>Zufall (${n}):</b> ${result}`;
  try {navigator.clipboard.writeText(result);}
  catch(e){logErr('Clipboard-Fehler: '+e);}
  statusMsg("Zufallsausgabe kopiert.",1);
  flash(document.getElementById('randResult'));
  addDashboardEntry(result);
  addLog('Zufallsausgabe erzeugt und kopiert.');
}
function loadWeights(){
  try { state.genreWeights = JSON.parse(localStorage.getItem(WEIGHT_KEY)) || {}; }
  catch(e){ state.genreWeights = {}; logErr('Gewicht-Laden: '+e); }
}
document.addEventListener('DOMContentLoaded', loadWeights);
function saveWeights(){
  localStorage.setItem(WEIGHT_KEY, JSON.stringify(state.genreWeights));
}
function renderWeightList(){
  const box = document.getElementById('weightList');
  if(!box) return;
  box.innerHTML = '';
  state.genres.forEach(g => {
    const row = document.createElement('div');
    row.className = 'weight-row';
    const sp = document.createElement('span');
    sp.textContent = g;
    const inp = document.createElement('input');
    inp.type='number';
    inp.min='1';
    inp.value = state.genreWeights[g] || 1;
    inp.onchange = () => { state.genreWeights[g]=Math.max(1,Number(inp.value)||1); saveWeights(); };
    row.appendChild(sp); row.appendChild(inp);
    box.appendChild(row);
  });
}
function pickWeightedRandom(){
  const pool=[];
  state.genres.forEach(g=>{ const w=Number(state.genreWeights[g]||1); for(let i=0;i<w;i++) pool.push(g); });
  if(pool.length===0){ statusMsg('Kein Genre vorhanden!',0); logErr('Gewichteter Zufall ohne Genres!'); return; }
  const pick = pool[Math.floor(Math.random()*pool.length)];
  const out = document.getElementById('weightResult');
  out.style.display='block';
  out.innerHTML = `<b>Gewichteter Zufall:</b> ${pick}`;
  try { navigator.clipboard.writeText(pick); } catch(e){ logErr('Clipboard-Fehler: '+e); }
  statusMsg('Gewichteten Zufall kopiert.',1); flash(out);
  state.dashboardData.unshift({value: pick, time: new Date().toLocaleString()});
  state.dashboardData = state.dashboardData.slice(0,10);
  localStorage.setItem(DASHBOARD_KEY, JSON.stringify(state.dashboardData));
  renderDashboard();
  addLog('Gewichteten Zufall erzeugt und kopiert.');
}
function saveArchive() {
  localStorage.setItem(LOCAL_KEY, JSON.stringify(state.genres));
  statusMsg("Archiv gespeichert!",1);
  addDashboardEntry('Archiv gespeichert');
  addLog('Archiv gespeichert.');
}
function loadArchive() {
  const data = localStorage.getItem(LOCAL_KEY);
  if(data) { state.genres = JSON.parse(data); sortAndUpdate(); statusMsg("Archiv geladen!",1); addDashboardEntry('Archiv geladen'); addLog('Archiv geladen.'); }
}
function copyDash(txt, btn) {
  try { navigator.clipboard.writeText(txt); }
  catch(e){ logErr('Clipboard-Fehler: '+e); flash(btn,'flash-error'); return; }
  statusMsg('In Zwischenablage.',1);
  flash(btn);
}
function copyTmpl(txt, btn, title) {
  try { navigator.clipboard.writeText(txt); }
  catch(e){ logErr('Clipboard-Fehler: '+e); flash(btn,'flash-error'); return; }
  tmplStatusMsg('Template kopiert: '+title,1);
  flash(btn);
  addLog('Template kopiert: '+title);
}
function resetArchive() {
  if(confirm('Archiv wirklich löschen?')) {
    localStorage.removeItem(LOCAL_KEY);
    state.genres = [];
    renderList();
    statusMsg('Archiv geleert!',1);
    addLog('Archiv geleert.');
  }
}
/* Dashboard */
function renderDashboard() {
  const el = document.getElementById('dashboardList');
  el.innerHTML = '';
  const ph = document.getElementById('dashEmpty');
  ph.style.display = state.dashboardData.length ? 'none' : 'block';
  state.dashboardData.forEach(item => {
    const li = document.createElement('li');
    li.innerHTML = `<span class="dashboard-timestamp">${item.time}</span> <span>${item.value}</span>
      <button class="dashboard-copy" title="Kopieren" onclick="copyDash('${item.value.replace(/'/g,"\\'")}', this)">⧉</button>`;
    el.appendChild(li);
  });
}
document.getElementById('clearDashboardBtn').onclick = function() {
  if(confirm('Alle Dashboard-Einträge wirklich löschen?')) {
    state.dashboardData = [];
    localStorage.removeItem(DASHBOARD_KEY);
    renderDashboard();
    logArr = [];
    renderDashLog();
    statusMsg("Dashboard geleert.",1);
    addDashboardEntry('Dashboard geleert');
    addLog('Dashboard gelöscht.');
  }
};
/* Templates */
function renderTmplList() {
  const el = document.getElementById('tmplBtnList');
  el.innerHTML = '';
  state.tmplArchiv.forEach((t,i)=>{
    const btn = document.createElement('button');
    btn.className = 'tmpl-btn';
    btn.innerText = t.title;
    btn.title = t.text.length > 40 ? t.text.substring(0,37)+'…' : t.text;
    btn.onclick = ()=> {
      try {navigator.clipboard.writeText(t.text);}
      catch(e){logErr('Clipboard-Fehler: '+e);}
      tmplStatusMsg("Template kopiert: "+t.title,1);
      addDashboardEntry('Template kopiert: '+t.title);
      addLog('Template kopiert: '+t.title);
    };
    btn.tabIndex = 0;
    const rem = document.createElement('button');
    rem.className = 'tmpl-remove';
    rem.innerText = '✖';
    rem.title = 'Template löschen';
    rem.onclick = (e)=>{e.stopPropagation();state.tmplArchiv.splice(i,1);saveTmpl();renderTmplList();addDashboardEntry('Template gelöscht');addLog('Template gelöscht.');};
    btn.appendChild(rem);
    el.appendChild(btn);
  });
}
function saveTmpl() {
  localStorage.setItem(TMPL_KEY, JSON.stringify(state.tmplArchiv));
}
function tmplStatusMsg(txt, ok=1) {
  let el = document.getElementById('tmplStatus');
  el.innerText = txt;
  el.className = 'status-msg ' + (ok ? 'status-ok':'status-error');
  el.style.display = 'block';
  setTimeout(()=>{el.style.display='none';},1800);
}
document.getElementById('tmplForm').onsubmit = function(e) {
  e.preventDefault();
  let title = document.getElementById('tmplTitle').value.trim();
  let text = document.getElementById('tmplText').value.trim();
  if(!title || !text) { tmplStatusMsg("Bitte Titel & Text angeben.",0); logErr('Template: Leere Felder'); return; }
  state.tmplArchiv.unshift({title, text});
  if(state.tmplArchiv.length>24) state.tmplArchiv=state.tmplArchiv.slice(0,24);
  saveTmpl();
  renderTmplList();
  document.getElementById('tmplTitle').value = '';
  document.getElementById('tmplText').value = '';
  tmplStatusMsg("Template hinzugefügt!",1);
  addDashboardEntry("Template hinzugefügt: "+title);
  addLog('Template hinzugefügt: '+title);
};
/* Suche im Archiv */
document.getElementById('searchInput').oninput = function() {
  const val = this.value;
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    state.searchTerm = val;
    document.getElementById('clearSearch').style.display = state.searchTerm ? '' : 'none';
    renderList();
  }, 200);
};
document.getElementById('clearSearch').onclick = function() {
  state.searchTerm = '';
  document.getElementById('searchInput').value = '';
  this.style.display = 'none';
  renderList();
};
/* Panel-Toggle */
function toggleModPanel(idx) {
  const cb = document.getElementById('mod'+idx+'box');
  document.getElementById('panel'+idx).style.display = cb.checked ? '' : 'none';
  renderFocusSelect();
  updateFocusButtons();
}
function toggleModuleList(){
  const wrap=document.getElementById('moduleListWrap');
  wrap.style.display = wrap.style.display==='none' ? '' : 'none';
}

function loadFavorites(){
  try { favorites = JSON.parse(localStorage.getItem(FAV_KEY)) || []; }
  catch(e){ favorites = []; }
}
function saveFavorites(){
  localStorage.setItem(FAV_KEY, JSON.stringify(favorites));
}
function toggleFavorite(id){
  const idx=favorites.indexOf(id);
  if(idx>=0) favorites.splice(idx,1); else favorites.push(id);
  saveFavorites();
  renderModuleList();
}
let moduleSearchTerm='';
function renderModuleList(){
  const list=document.getElementById('moduleList');
  if(!list) return;
  list.innerHTML='';
  const term=moduleSearchTerm.toLowerCase();
  const mods=[...modulesConfig];
  mods.sort((a,b)=>{
    const af=favorites.includes(a.id)?0:1;
    const bf=favorites.includes(b.id)?0:1;
    if(af!==bf) return af-bf;
    return a.title.localeCompare(b.title,'de');
  });
  mods.forEach(m=>{
    if(term && !m.title.toLowerCase().includes(term)) return;
    if(!document.getElementById(m.id)) return;
    const li=document.createElement('li');
    li.dataset.id=m.id;
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.className='sidebar-checkbox';
    cb.id='mod'+m.id.replace('panel','')+'box';
    cb.checked=true;
    cb.onchange=()=>toggleModPanel(parseInt(m.id.replace('panel',''))||0);
    const span=document.createElement('span');
    span.textContent=' '+m.title;
    const star=document.createElement('button');
    star.type='button';
    star.className='fav-btn';
    star.textContent=favorites.includes(m.id)?'★':'☆';
    star.onclick=()=>toggleFavorite(m.id);
    li.append(cb, span, star);
    list.appendChild(li);
  });
}
function addFocusButtons(){
  document.querySelectorAll('#gridMain .mod-panel').forEach((p,i)=>{
    const b=document.createElement('button');
    b.className='panel-focus-btn';
    b.type='button';
    b.textContent='Fokus';
    b.onclick=()=>switchFokus(i+1);
    p.insertBefore(b,p.firstChild);
  });
}

function handlePanelScroll(e){
  if(!scrollSync) return;
  const pos = e.target.scrollTop;
  document.querySelectorAll('#gridMain .mod-panel').forEach(p=>{
    if(p!==e.target) p.scrollTop = pos;
  });
}

function toggleScrollSync(){
  scrollSync = !scrollSync;
  const btn=document.getElementById('scrollSyncBtn');
  if(btn) btn.textContent = scrollSync ? 'Scrollsync: an' : 'Scrollsync: aus';
  document.querySelectorAll('#gridMain .mod-panel').forEach(p=>{
    p.removeEventListener('scroll', handlePanelScroll);
    if(scrollSync) p.addEventListener('scroll', handlePanelScroll);
  });
}
/* Meldungen & Reset */
function statusMsg(txt, ok=1) {
  const el = document.getElementById('toastLayer');
  if(!el) return;
  el.textContent = txt;
  el.className = 'toast-layer ' + (ok ? 'toast-ok' : 'toast-error');
  el.style.display = 'block';
  setTimeout(()=>{el.style.display='none';}, 2000);
}
function flash(el, cls='flash-success') {
  if(!el) return;
  el.classList.add(cls);
  setTimeout(()=>{ el.classList.remove(cls); }, 350);
}
function resetAll() {
  if(confirm("Alle Daten (Genres, Dashboard, Templates, Einstellungen) löschen?")) {
    localStorage.removeItem(LOCAL_KEY);
    localStorage.removeItem(DASHBOARD_KEY);
    localStorage.removeItem(TMPL_KEY);
    localStorage.removeItem(NOTES_KEY);
    state.genres = []; state.dashboardData = []; state.tmplArchiv = [];
    state.notesData = '';
    renderList(); renderDashboard(); renderTmplList();
    if(document.getElementById('notesArea')) document.getElementById('notesArea').value='';
    renderLog();
    statusMsg("Alles gelöscht!",1); tmplStatusMsg("Alles gelöscht!",1);
    addDashboardEntry("Alles gelöscht");
    addLog('Alles gelöscht.');
  }
}

/* Notizen-Panel */
function saveNotes(){
  state.notesData = document.getElementById('notesArea').value;
  localStorage.setItem(NOTES_KEY, state.notesData);
  addLog('Notizen gespeichert.');
}
function loadNotes(){
  const d = localStorage.getItem(NOTES_KEY);
  if(d){
    state.notesData = d;
    document.getElementById('notesArea').value = state.notesData;
  }
}
function clearNotes(){
  if(confirm('Alle Notizen löschen?')){
    state.notesData='';
    document.getElementById('notesArea').value='';
    localStorage.removeItem(NOTES_KEY);
    addLog('Notizen gelöscht.');
  }
}
/* Sidebar-Resize (optional) */
function makeSidebarResizable(side) {
  const dragbar = document.getElementById('dragbar'+side);
  const sidebar = document.getElementById('sidebar'+side);
  dragbar.addEventListener('mousedown', function(e) {
    e.preventDefault();
    document.body.style.cursor = "ew-resize";
    document.body.style.userSelect = "none";
    const startX = e.clientX;
    const startW = sidebar.offsetWidth;
    function dragHandler(ev) {
      let dx = ev.clientX - startX;
      let newW = side==='Left'
        ? Math.max(parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-min')), Math.min(startW + dx, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-max'))))
        : Math.max(parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-min')), Math.min(startW - dx, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sidebar-max'))));
      sidebar.style.width = newW+'px';
      document.documentElement.style.setProperty('--sidebar-width-'+side.toLowerCase(), newW+'px');
    }
    function stopDrag() {
      document.body.style.cursor = "";
      document.body.style.userSelect = "";
      window.removeEventListener('mousemove', dragHandler);
      window.removeEventListener('mouseup', stopDrag);
    }
    window.addEventListener('mousemove', dragHandler);
    window.addEventListener('mouseup', stopDrag);
  });
}
makeSidebarResizable('Left');
makeSidebarResizable('Right');
function loadPanel(id, cb){
  const cfg = modulesConfig.find(m=>m.id===id);
  const path = cfg && cfg.file ? cfg.file : 'modules/'+id+'.html';
  fetch(path)
    .then(r=>r.text())
    .then(html=>{document.getElementById(id).innerHTML = html; if(cb) cb();})
    .catch(e=>logErr('Panel-Load '+id+': '+e));
}
async function loadRegisteredPanels(){
  try {
    const res = await fetch('modules.json');
    if(!res.ok){
      if(res.status===404) throw new Error('Modulliste nicht gefunden (404) – ggf. deploy vergessen.');
      throw new Error('HTTP '+res.status);
    }
    let cfg;
    try { cfg = await res.json(); }
    catch(err){ throw new Error('modules.json defekt: '+err.message); }
    modulesConfig = cfg.modules;
    loadFavorites();
    renderModuleList();
    modulesConfig.forEach(m=>{
      if(m.id==='panel8') loadPanel(m.id, renderWeightList); else loadPanel(m.id);
    });
  } catch(e){
    logErr('Module-Liste: '+e.message);
    alert(e.message);
  }
}
loadRegisteredPanels();
// Intro-Overlay nach 20 Sekunden automatisch ausblenden
setTimeout(hideIntro, 20000);
document.addEventListener('keyup', e => { if(e.key === 'Escape') hideIntro(); });
function hideIntro(){
  const el = document.getElementById('introOverlay');
  if(el) el.remove();
}
function openHelp(){
  window.open('LAIENHILFE.md','_blank');
}
document.getElementById('copySelBtn').onclick = function(){
  const txt = window.getSelection().toString();
  if(!txt){ statusMsg('Nichts markiert!',0); return; }
  try { navigator.clipboard.writeText(txt); }
  catch(e){ logErr('Clipboard-Fehler: '+e); return; }
  const b = this; const old = b.style.background;
  b.style.background = 'var(--active)';
  setTimeout(()=>{ b.style.background = old; }, 350);
  statusMsg('Text kopiert.',1);
  addDashboardEntry('Manuell kopiert');
};
document.getElementById('toggleLeft').onclick = function(){
  document.getElementById('sidebarLeft').classList.toggle('show');
};
document.getElementById('toggleRight').onclick = function(){
  document.getElementById('sidebarRight').classList.toggle('show');
};
</script>
</body>
</html>
